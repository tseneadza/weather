{% extends "base.html" %}

{% block title %}Weather Dashboard - Weather Monitoring{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <h2>Weather Dashboard</h2>
        <button class="btn btn-primary" onclick="showAddLocation()">+ Add Location</button>
    </div>
    
    <div id="addLocationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeAddLocation()">&times;</span>
            <h3>Add Location</h3>
            <div class="search-box">
                <input type="text" id="locationSearch" placeholder="Search for a city..." autocomplete="off">
                <button class="btn btn-primary" onclick="searchLocations()">Search</button>
            </div>
            <div id="searchResults" class="search-results"></div>
        </div>
    </div>
    
    <div class="locations-grid">
        {% if locations_data %}
            {% for item in locations_data %}
            <div class="location-card">
                <div class="location-header">
                    <h3>{{ item.location.name }}</h3>
                    {% if item.location.region %}
                    <span class="location-region">{{ item.location.region }}, {{ item.location.country }}</span>
                    {% else %}
                    <span class="location-region">{{ item.location.country }}</span>
                    {% endif %}
                </div>
                
                {% if item.weather %}
                <div class="weather-date-dashboard">
                    <span class="date-label-dashboard">{{ item.weather.date.strftime('%A, %B %d, %Y') }}</span>
                </div>
                
                <div class="weather-display">
                    <div class="temp-main">
                        <span class="temp-value">{{ "%.1f"|format(item.weather.avg_temp) }}Â°C</span>
                        <span class="condition">{{ item.weather.condition_text }}</span>
                    </div>
                    <div class="weather-details">
                        <div class="detail-item">
                            <span class="label">High:</span>
                            <span class="value">{{ "%.1f"|format(item.weather.high_temp) }}Â°C</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Low:</span>
                            <span class="value">{{ "%.1f"|format(item.weather.low_temp) }}Â°C</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Precipitation:</span>
                            <span class="value">{{ "%.1f"|format(item.weather.precipitation_mm) }}mm</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Humidity:</span>
                            <span class="value">{{ item.weather.humidity }}%</span>
                        </div>
                        {% if item.weather.moon_phase %}
                        <div class="detail-item">
                            <span class="label">Moon:</span>
                            <span class="value">{{ item.weather.moon_phase }} ({{ "%.0f"|format(item.weather.moon_illumination) }}%)</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div class="weather-display">
                    <p class="no-data">No weather data available</p>
                </div>
                {% endif %}
                
                <!-- Weekly Average Section -->
                <div class="weekly-average" id="weekly-avg-{{ item.location.id }}">
                    <h4>ðŸ“Š Last 7 Days Average</h4>
                    <div class="weekly-avg-loading">Loading...</div>
                </div>
                
                {% if item.forecast %}
                <div class="forecast-weekly">
                    <h4>7-Day Forecast</h4>
                    <div class="forecast-list">
                        {% for day in item.forecast %}
                        <div class="forecast-item">
                            <div class="forecast-day-name">{{ day.forecast_date.strftime('%a') }}</div>
                            <div class="forecast-date-small">{{ day.forecast_date.strftime('%b %d') }}</div>
                            <div class="forecast-temps-small">
                                <span class="forecast-high">{{ "%.0f"|format(day.high_temp) }}Â°</span>
                                <span class="forecast-low">{{ "%.0f"|format(day.low_temp) }}Â°</span>
                            </div>
                            <div class="forecast-condition-small">{{ day.condition_text }}</div>
                            {% if day.chance_of_rain %}
                            <div class="forecast-rain">ðŸ’§ {{ day.chance_of_rain }}%</div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <div class="location-actions">
                    <a href="{{ url_for('location_detail', location_id=item.location.id) }}" class="btn btn-secondary">View Details</a>
                </div>
            </div>
            {% endfor %}
        {% else %}
        <div class="empty-state">
            <p>No locations added yet. Click "Add Location" to get started!</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function showAddLocation() {
    document.getElementById('addLocationModal').style.display = 'block';
}

function closeAddLocation() {
    document.getElementById('addLocationModal').style.display = 'none';
    document.getElementById('searchResults').innerHTML = '';
    document.getElementById('locationSearch').value = '';
}

function searchLocations() {
    const query = document.getElementById('locationSearch').value.trim();
    if (query.length < 2) {
        alert('Please enter at least 2 characters');
        return;
    }
    
    fetch(`/api/search?q=${encodeURIComponent(query)}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                displaySearchResults(data.data);
            } else {
                alert('Search failed: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(err => {
            alert('Error searching: ' + err.message);
        });
}

function displaySearchResults(locations) {
    const resultsDiv = document.getElementById('searchResults');
    if (locations.length === 0) {
        resultsDiv.innerHTML = '<p>No locations found</p>';
        return;
    }
    
    resultsDiv.innerHTML = locations.map(loc => `
        <div class="search-result-item" onclick="addLocation('${loc.name}', '${loc.country || ''}', '${loc.region || ''}')">
            <strong>${loc.name}</strong>
            ${loc.region ? loc.region + ', ' : ''}${loc.country || ''}
        </div>
    `).join('');
}

function addLocation(name, country, region) {
    fetch('/api/locations', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name: name, country: country, region: region})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Failed to add location: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        alert('Error adding location: ' + err.message);
    });
}

// Load weekly averages for all locations
function loadWeeklyAverages() {
    // Get all location IDs from the page
    const locationCards = document.querySelectorAll('.location-card');
    locationCards.forEach(card => {
        const weeklyAvgDiv = card.querySelector('[id^="weekly-avg-"]');
        if (weeklyAvgDiv) {
            const locationId = weeklyAvgDiv.id.replace('weekly-avg-', '');
            fetch(`/api/weekly-average/${locationId}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.data) {
                        const avgData = data.data;
                        weeklyAvgDiv.innerHTML = `
                            <h4>ðŸ“Š Last 7 Days Average</h4>
                            <div class="weekly-avg-stats">
                                <div class="weekly-avg-item">
                                    <span class="weekly-avg-label">Avg High:</span>
                                    <span class="weekly-avg-value high">${avgData.avg_high ? avgData.avg_high.toFixed(1) : 'N/A'}Â°C</span>
                                </div>
                                <div class="weekly-avg-item">
                                    <span class="weekly-avg-label">Avg Low:</span>
                                    <span class="weekly-avg-value low">${avgData.avg_low ? avgData.avg_low.toFixed(1) : 'N/A'}Â°C</span>
                                </div>
                                <div class="weekly-avg-info">
                                    <small>${avgData.days_count} days of data</small>
                                </div>
                            </div>
                        `;
                    } else {
                        weeklyAvgDiv.innerHTML = `
                            <h4>ðŸ“Š Last 7 Days Average</h4>
                            <div class="weekly-avg-stats">
                                <p class="no-data">Insufficient data</p>
                            </div>
                        `;
                    }
                })
                .catch(err => {
                    console.error('Error loading weekly average:', err);
                    weeklyAvgDiv.innerHTML = `
                        <h4>ðŸ“Š Last 7 Days Average</h4>
                        <div class="weekly-avg-stats">
                            <p class="no-data">Error loading data</p>
                        </div>
                    `;
                });
        }
    });
}

// Load weekly averages when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadWeeklyAverages();
});

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('addLocationModal');
    if (event.target == modal) {
        closeAddLocation();
    }
}
</script>
{% endblock %}
